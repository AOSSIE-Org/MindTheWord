<!DOCTYPE html>
<!--
 * Copyright (c) 2011 Bruno Woltzenlogel Paleo. All rights reserved.
-->
<html>
  <head>
    <title>MindTheWord Background</title>
    <script type="text/javascript"
src="http://www.google.com/jsapi"></script>

    <script>

function activation() {
  var a = localStorage["activation"];
  if (a != null) return a;
  else return "true";
}

function sourceLanguage() {
  var sL = localStorage["sourceLanguage"];
  if (sL) return sL;
  else return "auto";
}

function targetLanguage() {
  var tL = localStorage["targetLanguage"];
  if (tL) return tL;
  else return "en";
}

function translationProbability() {
  var tP = localStorage["translationProbability"];
  if (tP) return tP;
  else return 15;
}

function minimumSourceWordLength() {
  var mSWL = localStorage["minimumSourceWordLength"];
  if (mSWL) return mSWL;
  else return 0;
}

function translatedWordStyle() {
  var tWS = localStorage["translatedWordStyle"];
  if (tWS != null) return tWS;
  else return " ";
}

function userDefinedTranslations() {
  try {
    return JSON.parse(localStorage["userDefinedTranslations"]);
  } catch(e) {
    return {};
  }
}

function translationTimeout() {
  var tT = localStorage["translationTimeout"];
  if (tT) return tT;
  else return 50;
}

function googleTranslateURL() {
    var url = 'http://translate.google.com/translate_a/t?client=f&otf=1&pc=0&hl=en';
    var sL = sourceLanguage();
    if(sL != 'auto') {
      url += '&sl=' + sL;
    }
    url += '&tl=' + targetLanguage();
    url += '&text=';
    return url;
}	


function translateOneRequestPerFewWords(words, callback) {
  var concatWords = "";
  var trueLength = 0
  var concatWordsArray = {};
  var cWALength = 0;
  var maxLength = 800;
  for (word in words) {
    var wordTrueLength = encodeURIComponent(word + ". ").length;
    if (trueLength + wordTrueLength > maxLength) {
      cWALength++;
//    alert(concatWords + " " + cWALength);
      concatWordsArray[cWALength] = concatWords;
      concatWords = "";
      trueLength = 0;
    }
    concatWords += word + ". "  ;
    trueLength += wordTrueLength; 
  }
  var tMap = {};
  translateORPFWRec(concatWordsArray,1,cWALength,tMap,callback);
}

function translateORPFWRec(concatWordsArray, index, length, tMap,callback) {
  if (index > length) callback(tMap)
  else { 
    var url = googleTranslateURL() + concatWordsArray[index];
    var xhr = new XMLHttpRequest(); xhr.open("GET", url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4) {
        //alert(xhr.responseText);
        var r = JSON.parse(xhr.responseText);
        for (i in r.sentences) {
          var orig = r.sentences[i].orig;
          var origT = orig.substring(0,orig.length - 1);
	  var trans = r.sentences[i].trans;
          var transT = trans.replace(/[.\u3002]/,""); // removes punctuation
          tMap[origT] = transT;
        }
        translateORPFWRec(concatWordsArray, index + 1, length, tMap, callback);
      }
    }
    xhr.send();
  }
}  	

	
function onRequest(request, sender, sendResponse) {
  if (request.wordsToBeTranslated) {
    translateOneRequestPerFewWords(request.wordsToBeTranslated, function(tMap) {
      sendResponse({translationMap : tMap});
    });
  } else if (request.getOptions) {
    sendResponse({translationProbability : translationProbability(),
                  minimumSourceWordLength : minimumSourceWordLength(),
                  translatedWordStyle : translatedWordStyle(),
                  userDefinedTranslations : userDefinedTranslations(),
                  activation : activation()});
  } else if (request.getTranslationTimeout) {
    sendResponse({translationTimeout : translationTimeout()});
  }
};

chrome.extension.onRequest.addListener(onRequest);

function browserActionClicked() {
  chrome.tabs.create({url:chrome.extension.getURL("options.html")});
}

chrome.browserAction.onClicked.addListener(browserActionClicked);


    </script>
    
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1471148-13']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body onload="initGinyas();" ></body>
</html>
