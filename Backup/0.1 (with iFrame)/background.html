<!DOCTYPE html>
<!--
 * Copyright (c) 2010 The Chromium Authors. All rights reserved.  Use of this
 * source code is governed by a BSD-style license that can be found in the
 * LICENSE file.
-->
<html>
  <head>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script>


//function _translate(text, from, to, callback) {
  //alert("hi")
//  var url = 'http://translate.google.com/translate_a/t?client=f&otf=1&pc=0';
//  url += '&text=' + text;
//  url += '&hl=en';
//  if(from != 'auto') {
//    url += '&sl=' + from;
//  }
//  url += '&tl=' + to;
//  var xhr = new XMLHttpRequest();
//  xhr.open("GET", url, true);
//  xhr.onreadystatechange = function() {
//    if (xhr.readyState == 4) {
//      var r = JSON.parse(xhr.responseText)
//      callback(r);
//   }
//  }
//  xhr.send();
//}


function sourceLanguage() {
  return 'auto'	
}


function targetLanguage() {
  var tL = localStorage["targetLanguage"]
  if (tL) return tL
  else return "en"
}

function translationProbability() {
  var tP = localStorage["translationProbability"]
  if (tP) return tP
  else return 10
}

function translateWord(word, callback) {
  _translate(word, "auto", targetLanguage(), function(r) {callback(r.sentences[0].trans)})
}



function translateWords(words, callback) {
  var tMap = {}
  
  //alert(JSON.stringify(words))
  var concatWords = ""
  for (word in words) {
    concatWords += word + ". "   
  }

  //alert(concatWords)

  var url = 'http://translate.google.com/translate_a/t?client=f&otf=1&pc=0';
  url += '&text=' + concatWords;
  url += '&hl=en';
  if(sourceLanguage() != 'auto') {
    url += '&sl=' + sourceLanguage();
  }
  url += '&tl=' + targetLanguage();
  //alert(url);
  var xhr = new XMLHttpRequest();
  xhr.open("GET", url, true);
  xhr.onreadystatechange = function() {
    //alert(xhr.readyState);
    if (xhr.readyState == 4) {
      //alert(xhr.status);
      //alert("hello " + xhr.responseText.toString() + xhr.responseText.length)
      var r = JSON.parse(xhr.responseText)
      //var r = JSON.parse(xhr.responseText)
      //alert("hi")
//alert(JSON.stringify(r.sentences))

      for (index in r.sentences) {
	      var orig = r.sentences[index].orig
        var origT = orig.substring(0,orig.length - 1)
	      var trans = r.sentences[index].trans
	      if (trans.substr(trans.length - 2) == ". " ) { 
          var transT = trans.substring(0,trans.length - 2)
        }
	      else if (trans.substr(trans.length - 1) == "." ) { 
          var transT = trans.substring(0,trans.length - 1)
        }
        else {transT = trans}
        tMap[origT] = transT
      }    
      
      //alert("hey-ho")
      //alert(JSON.stringify(tMap))

      callback(tMap);
    }
  }
  xhr.send();       
}  	
	


function length(associativeArray) {
  var l = 0
  for (e in associativeArray) { l++ }
  return l      	
}
	
function onRequest(request, sender, sendResponse) {
  // Show the page action for the tab that the sender (content script) was on.
  // chrome.pageAction.show(sender.tab.id);

//alert("8")

  if (request.wordsToBeTranslated) {
 
//alert("9")     
 
    translateWords(request.wordsToBeTranslated, function(tMap) {
      sendResponse({translationMap : tMap});
    });
  } else if (request.wordToBeTranslated) {
    translateWord(request.wordToBeTranslated, function(translation) {
      sendResponse({translatedWord : translation});
    });
  } else if (request.translationProbability) {
    sendResponse({translationProbability : translationProbability()})
  }  
};

// Listen for the content script to send a message to the background page.
chrome.extension.onRequest.addListener(onRequest);



    </script>
  </head>
</html>
